const quizData = {
    topic1: [
        {
            question: "Was ist das Hauptziel des Beteiligungsverfahrens für den Alter Markt in Barmen?",
            options: ["Die Bürger*innen zur Teilnahme an Wahlen motivieren", "Ein Konzept für die Umgestaltung zu entwickeln, das die Bedürfnisse der Menschen vor Ort berücksichtigt", "Einen neuen Parkplatz in der Innenstadt zu schaffen", "Die Anzahl der Besucherinnen des Platzes zu reduzieren"],
            correctAnswer: 1,
            explanation: "Das Beteiligungsverfahren soll die Verwaltung und das Planungsbüro dabei unterstützen, ein Konzept für die Umgestaltung zu erarbeiten und umzusetzen, welches die Bedingungen vor Ort und die Bedarfe und Präferenzen der Menschen berücksichtigt."
        },
        {
            question: "Welches temporäre Konzept wird vor der dauerhaften Umgestaltung getestet?",
            options: ["Ein neuer Fahrradweg", "Ein Einkaufszentrum", "Ein Flohmarkt", "Ein Pop-Up Park"],
            correctAnswer: 3,
            explanation: "Vor der endgültigen Umgestaltung des Platzes wird ein Pop-Up Park eingerichtet. Im Rahmen dieser Maßnahme sollen verschiedene Ideen probeweise umgesetzt und getestet werden. Dazu gehört auch mehr Sitzgelegenheiten anzubieten."
        },
        {
            question: "Welche Einschränkung besteht bei der Finanzierung der Umgestaltung?",
            options: ["Es darf kein Geld für Sitzgelegenheiten ausgegeben werden", "Es gibt keinerlei finanzielle Begrenzung", "Die Mittel dürfen nur für eine klimagerechte und barrierefreie Umgestaltung genutzt werden","Das Budget darf nur für den Bau von Spielplätzen verwendet werden"],
            correctAnswer: 2,
            explanation: "80 % des Budgets stammen aus Städtebaufördermitteln. Diese sind an Bedingungen geknüpft. Das Geld kann nur für eine klimagerechte und barrierefreie Umgestaltung des Platzes eingesetzt werden."
        },
        {
            question: "Wie sollen Bürger*innen am Beteiligungsverfahren teilnehmen?",
            options: ["Durch Postkarten-Aktionen, Online-Umfragen und Beteiligung vor Ort", "Durch telefonische Befragungen", "Durch Abstimmung im Rathaus", "Durch eine Bürger*innenversammlung einmal im Jahr"],
            correctAnswer: 0,
            explanation: "Die Beteiligung erfolgt durch Online-Befragungen, um möglichst vielen Bürger*innen eine einfache und zeitlich flexible Teilnahme zu ermöglichen. Gleichzeitig ermöglichen die anderen Formate auch Beteiligung vor Ort."
        },
        {
            question: "Warum werden für die Evaluation des Pop-Up Parks verschiedene Zeiträume eingeplant?",
            options: ["Weil nicht genug Personal für eine dauerhafte Beteiligung vorhanden ist", "Damit möglichst viele Touristen an der Umfrage teilnehmen können", "Um sicherzustellen, dass nur die Anwohner*innen befragt werden", "Um Veränderungen in verschiedenen Jahreszeiten zu berücksichtigen"],
            correctAnswer: 3,
            explanation: "Die Evaluation zu verschiedenen Jahreszeiten ist wichtig, um zu verstehen, wie der Platz das ganze Jahr über genutzt wird und welche jahreszeitabhängigen Bedürfnisse berücksichtigt werden müssen."
        },   

    ],
    topic2: [
        {
            question: "Was ist der Hauptunterschied zwischen formeller und informeller Bürgerbeteiligung?",
            options: ["Formelle Bürgerbeteiligung ist gesetzlich vorgeschrieben, während informelle Bürgerbeteiligung freiwillig ist.", "Nur bei informeller Bürgerbeteiligung können Bürgerinnen selbst über politische Entscheidungen abstimmen.", "Formelle Bürgerbeteiligung findet nur online statt, während informelle Bürgerbeteiligung nur in Präsenz erfolgt.", "Informelle Bürgerbeteiligung ist nur für Einwohnerinnen der Stadt zugänglich, während formelle Bürgerbeteiligung für alle offen ist."],
            correctAnswer: 0,
            explanation: "Formelle Bürgerbeteiligung ist in Gesetzen geregelt (z. B. Bauleitplanung, Einwohneranträge, Bürgerentscheide) und muss von politischen Gremien beachtet werden. Informelle Bürgerbeteiligung ist nicht gesetzlich vorgeschrieben, sondern dient dazu, Bürger*innen freiwillig in politische Prozesse einzubeziehen. Sie bietet mehr Flexibilität und ist oftmals dialogorientiert."
        },
        {
            question: "Wovon soll die Beteiligungskultur in Wuppertal geprägt sein?",
            options: ["Wettbewerbe zwischen Bürger*innen für die beste Idee", "Frühzeitige Einbindung von Bürger*innen und Gleichberechtigung verschiedener Gruppen", "Bevorzugung bestimmter Gruppen", "Schnelle Umsetzung von Bauentwürfen"],
            correctAnswer: 1,
            explanation: "Die Leitlinien für gute Bürgerbeteiligung in Wuppertal legen Wert auf eine konstruktive und faire Bürgerbeteiligung. Zu den Kernwerten gehören Zusammenarbeit, Kommunikation, Verbindlichkeit, Transparenz, Frühzeitigkeit und Inklusion. Diese Prinzipien sollen sicherstellen, dass möglichst viele Bürger*innen sich einbringen können und ernst genommen werden."
        },
        {
            question: "Welche zentrale Aufgabe haben die Leitlinien für Bürgerbeteiligung in Wuppertal?",
            options: ["Sie ersetzen die Entscheidungsbefugnis von Rat und Verwaltung.", "Sie verpflichten alle Bürger*innen zur Teilnahme an Beteiligungsverfahren.", "Sie regeln ausschließlich formelle Bürgerbeteiligungsverfahren.", "Sie geben Orientierung für die Einbeziehung der Bürgerinnen in kommunale Vorhaben."],
            correctAnswer: 3,
            explanation: "Die Leitlinien dienen als Rahmen für Bürgerbeteiligungsprozesse in Wuppertal. Sie sollen Einwohnerinnen, Politik und Verwaltung Orientierung geben, wie Beteiligungsverfahren gestaltet werden sollen. Dabei ersetzen sie nicht die Entscheidungsbefugnisse von Rat und Verwaltung, sondern ergänzen diese durch zusätzliches Wissen, Erfahrung und Engagement der Bürgerinnen."
        },
        {
            question: "Wer hat die Leitlinien für Bürgerbeteiligung in Wuppertal entwickelt?",
            options: ["Nur die Stadtverwaltung", "Eine Arbeitsgruppe aus Bürger*innen, Politiker*innen und Verwaltungsmitarbeiter*innen", "Der Oberbürgermeister allein", "Ein externes Beratungsunternehmen"],
            correctAnswer: 1,
            explanation: "Die Leitlinien wurden in einem partizipativen Prozess von einer Arbeitsgruppe entwickelt, die sich aus Bürger*innen, Politiker*innen und Verwaltungsmitarbeiter*innen zusammensetzte. Dies gewährleistet, dass verschiedene Perspektiven berücksichtigt wurden."
        },
        {
            question: "Welche Aufgabe hat der Beirat für Bürgerbeteiligung in Wuppertal?",
            options: ["Er überprüft, ob sich Politik und Verwaltung an die Leitlinien für Bürgerbeteiligung halten.", "Er entscheidet über alle neuen Bauprojekte in Wuppertal.", "Er organisiert Wahlen für den Stadtrat.", "Er verwaltet das Budget der Stadt."],
            correctAnswer: 0,
            explanation: "Der Beirat für Bürgerbeteiligung setzt sich aus Bürgerinnen, Politikerinnen und Verwaltungsmitarbeiter*innen zusammen. Seine Hauptaufgabe ist es, die Einhaltung der Leitlinien zu prüfen und Vorschläge zur Verbesserung der Bürgerbeteiligung zu machen."
        },
    ],
    topic3: [
        {
            question: "Warum werden Pop-Up Parks eingerichtet?",
            options: ["Um neue Parkplätze für die Innenstadt zu schaffen", "Um Maßnahmen zur Anpassung an den Klimawandel zu erproben", "Um den Platz als Festivalgelände zu nutzen", "Um ein Einkaufszentrum zu bauen"],
            correctAnswer: 1 ,
            explanation: "Pop-Up Parks dienen als Experimentier- und Lernort, um verschiedene Lösungen für Klimaanpassung wie Begrünung und Flächenentsiegelung zu testen. Die gewonnenen Erkenntnisse fließen in die langfristige Planung der Fläche ein."
        },
        {
            question: "Welche klimatischen Probleme gibt es besonders in den Tallagen von Wuppertal? Es gibt...",
            options: ["Zu viele Grünflächen, die zu starker Abkühlung führen", "Zu viel Regen, der durch die gut durchlässigen Böden sofort abfließt", "Starke Winde aufgrund des Klimawandels", "Hohe Temperaturen durch dunkle, asphaltierte Flächen und fehlende Regenwasseraufnahme"],
            correctAnswer: 3,
            explanation: "In den Tallagen von Wuppertal gibt es viele dunkle, versiegelte Flächen (z. B. Asphalt, Pflastersteine), die sich im Sommer stark aufheizen. Zudem kann Regenwasser nicht richtig versickern, was bei Starkregen zu Überschwemmungen führt."
        },
        {
            question: "Warum ist es sinnvoll, versiegelte Flächen durch Materialien wie Holzschnitzel oder Gras zu ersetzen?",
            options: ["Weil versiegelte Flächen grundsätzlich kühler sind als begrünte Flächen", "Weil Holzschnitzel und Gras das Wachstum von Unkraut in der Umgebung verhindern", "Weil Holzschnitzel und Gras weniger Hitze speichern als Stein oder Beton und besser Regenwasser aufnehmen können", "Weil Steinplatten und Beton CO2 aus der Luft filtern"],
            correctAnswer: 2,
            explanation: "Versiegelte Flächen wie Beton und Steinplatten heizen sich in der Sonne stark auf und speichern die Wärme, wodurch es in Städten im Sommer besonders heiß wird. Außerdem können sie kaum Wasser aufnehmen, was bei Starkregen zu Überschwemmungen führt. Materialien wie Holzschnitzel oder Gras reduzieren die Hitzespeicherung und verbessern die Versickerung von Regenwasser, wodurch das Stadtklima angenehmer wird. Messungen im PopUp-Park Barmen haben ergeben, dass bis zu 20 Grad Temperaturunterschied bei Sonnenbestrahlung entstehen können."
        },
        {
            question: "Wieso sollten Bürger*innen in die Umsetzung von Klimaschutzmaßnahmen einbezogen werden?",
            options: ["Weil Bürger*innen durch ihr Engagement dazu beitragen können, dass Klimaschutzmaßnahmen besser an die Bedürfnisse der Stadtgesellschaft angepasst werden", "Weil Bürger*innen durch ihre Beteiligung die Verwaltung entlasten und weniger staatliche Investitionen nötig sind", "Weil Klimaschutz ausschließlich eine private Aufgabe ist und nicht von der Stadtverwaltung gesteuert werden sollte", "Weil es gesetzlich Pflicht ist Bürger*innen einzubeziehen, obwohl lokale Maßnahmen keinen Einfluss auf Klimaschutz haben"],
            correctAnswer: 0,
            explanation: "Lokale Maßnahmen spielen eine entscheidende Rolle im Klimaschutz, da sie unmittelbare Auswirkungen auf die Umwelt haben und das Bewusstsein der Menschen stärken. Durch grüne Stadtgestaltung, Entsiegelung von Flächen und Bürgerbeteiligung sind konkrete Veränderungen möglich, die zur Klimaanpassung und -minderung beitragen."
        },
        {
            question: "Wie kann das Wohnumfeld für eine klimaangepasste Stadtentwicklung verbessert werden?",
            options: ["Indem Grünflächen und öffentliche Räume reduziert werden, um mehr Platz für Straßen und Parkplätze zu schaffen", "Durch den verstärkten Einsatz von Asphalt und Beton, um die Stadt widerstandsfähiger gegen Wettereinflüsse zu machen", "Durch die Schaffung barrierefreier Aufenthaltsflächen und Grünflächen, um das Mikroklima zu verbessern und die Stadt lebenswerter zu machen", "Indem man versiegelte Flächen beibehält und keine zusätzlichen Grünflächen schafft, um den Pflegeaufwand für die Stadt zu reduzieren"],
            correctAnswer: 2,
            explanation: "Die Schaffung und Verbesserung von Grünflächen und öffentlichen Räumen ist ein zentrales Ziel einer klimaangepassten Stadtentwicklung, um das Mikroklima zu regulieren und für mehr Aufenthaltsqualität zu sorgen. Versiegelte Flächen tragen zur Erwärmung der Stadt bei, da sie Wärme speichern und kaum Wasser aufnehmen können."
        },
    ]
};

let currentQuestions = [];
let currentQuestionIndex = 0;
let points = 0;
let answered = false;
let completedTopics = JSON.parse(localStorage.getItem('completedTopics')) || {};
let totalScore = Object.values(completedTopics).reduce((sum, score) => sum + score, 0);
let correctAnswers = 0;
let selectedAnswer = undefined;

// DOM Elements
const topicSelection = document.getElementById('topic-selection');
const quizScreen = document.getElementById('quiz-screen');
const resultsScreen = document.getElementById('results-screen');
const questionCounter = document.getElementById('question-counter');
const pointsDisplay = document.getElementById('points');
const questionElement = document.getElementById('question');
const answerButtons = [
    document.getElementById('answer-1'),
    document.getElementById('answer-2'),
    document.getElementById('answer-3'),
    document.getElementById('answer-4')
];
const nextBtn = document.getElementById('next-btn');
const totalPointsElement = document.getElementById('total-points');
const percentageElement = document.getElementById('percentage');
const feedbackElement = document.getElementById('feedback');
const restartBtn = document.getElementById('restart-btn');
const abortButton = document.getElementById('abort-btn');

// Add event listeners
document.querySelectorAll('.topic-btn').forEach(button => {
    button.addEventListener('click', () => startQuiz(button.dataset.topic));
});

answerButtons.forEach((button, index) => {
    button.addEventListener('click', () => {
        if (!answered) {
            // Reset all buttons
            answerButtons.forEach(btn => {
                btn.className = 'answer-btn bg-white text-[#513be4] p-4 rounded-lg hover:bg-gray-100 border-2 border-[#513be4]';
            });
            
            // Highlight selected button
            button.className = 'answer-btn bg-gray-200 text-[#513be4] p-4 rounded-lg border-2 border-[#513be4]';
            selectedAnswer = index;
        }
    });
});

nextBtn.addEventListener('click', nextQuestion);
restartBtn.addEventListener('click', showTopicSelection);
document.getElementById('reset-btn').addEventListener('click', resetScores);
document.getElementById('abort-btn').addEventListener('click', abortQuiz);

function startQuiz(topic) {
    currentQuestions = quizData[topic];
    currentQuestionIndex = 0;
    points = 0;
    answered = false;
    
    topicSelection.classList.add('hidden');
    quizScreen.classList.remove('hidden');
    resultsScreen.classList.add('hidden');
    
    // Initialize progress bar with 0% width
    const progressBar = document.getElementById('progress-bar');
    progressBar.className = 'h-2.5 rounded-full bg-gray-300';
    progressBar.style.width = '0%';
    
    updateQuestion();
    updatePoints();
}

function updateQuestion() {
    const question = currentQuestions[currentQuestionIndex];
    questionElement.textContent = question.question;
    questionCounter.textContent = `Frage ${currentQuestionIndex + 1}/5`;
    
    // Remove any existing explanation
    const existingExplanation = document.querySelector('.explanation-box');
    if (existingExplanation) {
        existingExplanation.remove();
    }
    
    // Update answer buttons
    question.options.forEach((option, index) => {
        answerButtons[index].textContent = option;
        answerButtons[index].className = 'answer-btn bg-white text-[#513be4] p-4 rounded-lg hover:bg-gray-200 border-2 border-[#513be4]';
    });
    
    selectedAnswer = undefined;
    answered = false;
    nextBtn.disabled = false;
    
    // Update progress bar
    const progress = (currentQuestionIndex / currentQuestions.length) * 100;
    const progressBar = document.getElementById('progress-bar');
    progressBar.style.width = `${progress}%`;
    
    // Update progress bar color based on points
    const scorePercentage = (points / 50) * 100;
    if (scorePercentage >= 80) {
        progressBar.className = 'h-2 rounded-full bg-violet-500';
    } else if (scorePercentage >= 60) {
        progressBar.className = 'h-2 rounded-full bg-violet-400';
    } else if (scorePercentage >= 40) {
        progressBar.className = 'h-2 rounded-full bg-violet-300';
    } else if (scorePercentage >= 20) {
        progressBar.className = 'h-2 rounded-full bg-violet-200';
    } else {
        progressBar.className = 'h-2 rounded-full bg-gray-300';
    }
}

function updatePoints() {
    // Ensure points never exceed 50
    points = Math.min(points, 50);
    pointsDisplay.textContent = `Punkte: ${points}`;
}

function nextQuestion() {
    if (selectedAnswer === undefined) {
        alert('Bitte wähle eine Antwort aus.');
        return;
    }
    
    const question = currentQuestions[currentQuestionIndex];
    const correctAnswer = question.correctAnswer;
    
    if (!answered) {
        // Show correct/incorrect
        if (selectedAnswer === correctAnswer) {
            answerButtons[selectedAnswer].className = 'answer-btn bg-green-100 text-green-700 p-4 rounded-lg border-2 border-green-500';
            points += 10;
            updatePoints();
        } else {
            answerButtons[selectedAnswer].className = 'answer-btn bg-red-100 text-red-700 p-4 rounded-lg border-2 border-red-500';
            answerButtons[correctAnswer].className = 'answer-btn bg-green-100 text-green-700 p-4 rounded-lg border-2 border-green-500';
        }
        
        // Remove any existing explanation
        const existingExplanation = document.querySelector('.explanation-box');
        if (existingExplanation) {
            existingExplanation.remove();
        }
        
        // Display explanation
        if (question.explanation) {
            const explanationElement = document.createElement('div');
            explanationElement.className = 'explanation-box mt-4 p-4 bg-gray-100 text-gray-800 rounded-lg';
            explanationElement.innerHTML = `<strong>Erklärung:</strong> ${question.explanation}`;
            document.getElementById('question-container').appendChild(explanationElement);
        }
        
        answered = true;
        nextBtn.textContent = 'Weiter';
    } else {
        // Move to next question when user clicks "Next" after seeing the explanation
        currentQuestionIndex++;
        if (currentQuestionIndex >= currentQuestions.length) {
            showResults();
        } else {
            updateQuestion();
        }
    }
}

function updateTotalScore() {
    totalScore = Object.values(completedTopics).reduce((sum, score) => sum + score, 0);
    const totalScoreElement = document.getElementById('total-score');
    totalScoreElement.textContent = `Erreichte Punkte: ${totalScore}/150`;
    saveTotalScore();
}

function showResults() {
    quizScreen.classList.add('hidden');
    resultsScreen.classList.remove('hidden');
    
    // Calculate points and percentage
    points = Math.min(points, 50);
    const percentage = (points / 50) * 100;
    
    // Update results progress bar
    const resultsProgressBar = document.getElementById('results-progress-bar');
    resultsProgressBar.style.width = `${percentage}%`;
    
    // Set progress bar color based on score
    if (percentage >= 80) {
        resultsProgressBar.className = 'h-2.5 rounded-full bg-green-500';
    } else if (percentage >= 60) {
        resultsProgressBar.className = 'h-2.5 rounded-full bg-green-400';
    } else if (percentage >= 40) {
        resultsProgressBar.className = 'h-2.5 rounded-full bg-green-300';
    } else if (percentage >= 20) {
        resultsProgressBar.className = 'h-2.5 rounded-full bg-green-200';
    } else {
        resultsProgressBar.className = 'h-2.5 rounded-full bg-gray-300';
    }
    
    totalPointsElement.textContent = `Gesamtpunkte: ${points} von 50`;
    percentageElement.textContent = `Prozent: ${percentage}%`;
    
    // Store the points for this topic only if it's higher than the previous score
    const currentTopic = Object.keys(quizData).find(topic => 
        quizData[topic] === currentQuestions
    );
    
    if (!completedTopics[currentTopic] || points > completedTopics[currentTopic]) {
        completedTopics[currentTopic] = points;
        localStorage.setItem('completedTopics', JSON.stringify(completedTopics));
        updateTotalScore();
    }
    
    console.log('Points:', points);
    console.log('Percentage:', percentage);
    console.log('feedbackElement:', feedbackElement);
    
    if (percentage >= 100) {
        feedbackElement.textContent = "Super, alles wurde richtig beantwortet!";
    } else if (percentage >= 75) {
        feedbackElement.textContent = "Super, die meisten Fragen wurden richtig beantwortet!";
    } else if (percentage >= 50) {
        feedbackElement.textContent = "Gut, aber es gibt noch Verbesserungsmöglichkeiten!";
    } else {
        feedbackElement.textContent = "Einige Fragen wurden leider falsch beantwortet. Versuche es nochmal!";
    }
}

function updateTopicButtons() {
    document.querySelectorAll('.topic-btn').forEach(button => {
        const topic = button.dataset.topic;
        if (completedTopics[topic] !== undefined) {
            button.classList.remove('bg-blue-500', 'hover:bg-blue-600');
            button.classList.add('bg-violet-300', 'hover:bg-violet-400');
        } else {
            button.classList.remove('bg-violet-300', 'hover:bg-violet-400');
            button.classList.add('bg-white', 'hover:bg-gray-200');
        }
    });
}

function showTopicSelection() {
    topicSelection.classList.remove('hidden');
    resultsScreen.classList.add('hidden');
    updateTopicButtons();
}

function resetScores() {
    if (confirm('Möchtest du wirklich alle Punkte zurücksetzen?')) {
        // Reset all stored data
        completedTopics = {};
        localStorage.removeItem('completedTopics');
        totalScore = 0;
        updateTotalScore();
        
        // Reset all topic buttons back to blue
        document.querySelectorAll('.topic-btn').forEach(button => {
            button.classList.remove('bg-violet-300', 'hover:bg-violet-400');
            button.classList.add('bg-gray-200', 'hover:bg-gray-200');
            button.textContent = button.textContent.split(' (')[0];
        });
    }
}

document.addEventListener('DOMContentLoaded', () => {
    updateTotalScore();
    updateTopicButtons();
    if (abortButton) {
        abortButton.addEventListener('click', abortQuiz);
        console.log('Abort button listener added'); // Debug log
    }
});

// Add these functions for the details modal
function showDetailsModal() {
    const modal = document.getElementById('details-modal');
    const topicScoresDiv = document.getElementById('topic-scores');
    
    // Clear previous content
    topicScoresDiv.innerHTML = '';
    
    // Add score for each topic
    Object.keys(quizData).forEach((topic, index) => {
        const score = completedTopics[topic] || 0;
        const topicElement = document.createElement('div');
        topicElement.className = 'flex justify-between items-center';
        topicElement.innerHTML = `
            <span>Thema ${index + 1}:</span>
            <span>${score}/50 Punkte</span>
        `;
        topicScoresDiv.appendChild(topicElement);
    });
    
    modal.classList.remove('hidden');
}

function hideDetailsModal() {
    const modal = document.getElementById('details-modal');
    modal.classList.add('hidden');
}

// Add these event listeners with the other listeners
document.getElementById('details-btn').addEventListener('click', showDetailsModal);
document.getElementById('close-modal-btn').addEventListener('click', hideDetailsModal);

// Close modal when clicking outside
document.getElementById('details-modal').addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
        hideDetailsModal();
    }
});

function abortQuiz() {
    console.log('Abort button clicked'); // Debug log
    if (confirm('Möchtest du das Quiz wirklich abbrechen? Der Fortschritt geht verloren.')) {
        // Reset quiz state
        currentQuestionIndex = 0;
        points = 0;
        answered = false;
        selectedAnswer = undefined;
        
        // Update points display
        pointsDisplay.textContent = 'Punkte: 0';
        
        // Reset progress bar
        const progressBar = document.getElementById('progress-bar');
        if (progressBar) {
            progressBar.style.width = '0%';
            progressBar.className = 'h-2 rounded-full bg-gray-300';
        }
        
        // Hide quiz screen and show topic selection
        quizScreen.classList.add('hidden');
        resultsScreen.classList.add('hidden');
        topicSelection.classList.remove('hidden');
    }
} 
